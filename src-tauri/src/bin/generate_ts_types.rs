#[cfg(not(feature = "typegen"))]
fn main() {
    eprintln!(
        "Type generation is disabled. Run with:\n  cargo run --manifest-path src-tauri/Cargo.toml --bin generate_ts_types --features typegen"
    );
    std::process::exit(1);
}

#[cfg(feature = "typegen")]
fn main() -> Result<(), Box<dyn std::error::Error>> {
    use specta::TypeCollection;
    use specta_typescript::{BigIntExportBehavior, Typescript};

    let mut types = TypeCollection::default();

    // Window/bridge shared types
    types.register::<app_lib::WindowMode>();

    // AI config types
    types.register::<app_lib::services::config::AiProvider>();
    types.register::<app_lib::services::config::AiModel>();
    types.register::<app_lib::services::config::AiConfig>();

    // Vision module types
    types.register::<app_lib::services::vision::ScreenCaptureResult>();
    types.register::<app_lib::services::vision::VlmAnalysisResult>();
    types.register::<app_lib::services::vision::WindowInfo>();

    // History module types
    types.register::<app_lib::services::history::ConversationSummary>();
    types.register::<app_lib::services::history::ConversationMessage>();
    types.register::<app_lib::services::history::ConversationDetail>();
    types.register::<app_lib::services::history::HistoryBootstrap>();

    let mut exporter = Typescript::new()
        // We use millisecond timestamps (u64) within JS-safe range in practice.
        .bigint(BigIntExportBehavior::Number)
        .header(
            "/* eslint-disable */\n// @generated by `cargo run --manifest-path src-tauri/Cargo.toml --bin generate_ts_types --features typegen`\n",
        );

    // Keep the generated file compact and stable (no Rust doc comment churn).
    exporter.comment_exporter = None;

    let ts = exporter.export(&types)?;

    let out_path =
        std::path::PathBuf::from(env!("CARGO_MANIFEST_DIR")).join("../src/bindings/tauri-types.ts");

    if let Some(parent) = out_path.parent() {
        std::fs::create_dir_all(parent)?;
    }

    std::fs::write(&out_path, ts)?;
    println!("Wrote {}", out_path.display());
    Ok(())
}
