# P0 进展回顾（2026-01-14）

> 目标：以 **VRM 角色窗口（avatar）为主体**，在 Windows 上完成 P0 可用性验证：  
> - 角色像素命中：角色区域可交互、角色外鼠标穿透。  
> - 面板（panel/main）：右键召唤、点外部稳定隐藏；交互（拖拽/缩放/滚轮）不应导致误隐藏。  
> - Debug 体验：能快速定位窗口/命中/焦点/穿透问题。

---

## 今日完成（按“用户感知”排序）

1. **点击/穿透（avatar）**
   - 角色边界可视化（红边框）用于确认 mask 质量。
   - Windows 下通过 subclass + mask 命中让角色外返回 `HTTRANSPARENT`，并提供 30Hz “cursor gate” 兜底，避免偶发的穿透失败。

2. **Panel 的“隐藏”语义（VRM-first）**
   - 面板关闭（系统右上角 X）不退出应用，改为 `hide`。
   - 面板从前端直接 `window.hide()` 改为 Rust command `dismiss_capsule`，避免权限/能力配置导致的“hide 不可靠”。

3. **Panel 自动隐藏稳定性**
   - 不再完全依赖 `blur/focus`（Windows + 非激活 avatar 触发焦点规则很不稳定）。
   - Windows 新增“全局左键点外部隐藏”的后台 watcher：点击落点不在 panel 时隐藏 panel。
   - 前端对 `blur` 增加 grace period，避免“刚打开就 blur 立即消失”。

4. **Panel 内控件导致的误隐藏（已定位并修复）**
   - 问题：在 panel 的 VRM 页/Debug 页点击原生 HTML `<select>` 下拉项，会被识别为“点到 panel 外部”，导致 hide。
   - 根因：WebView2/系统会为原生 `<select>` 创建独立的 popup HWND（不属于 panel 的窗口树），全局点外部判断会误判。
   - 修复：将 panel 里的 `<select>` 替换为 Radix `Select`（portal 仍在同一 webview DOM 内，不会创建独立 HWND）。

5. **滚轮/滚动体验（进行中）**
   - 增强 panel 在打开时的“置顶/前台”处理，减少 wheel 事件被 avatar 抢走的概率。
   - 调整 ResultView 的 flex，让消息区具备正确的 overflow/scroll 条件。

---

## 今日遇到的典型问题与结论

### A. “红框外仍然不穿透”
- 结论：红框只是边界显示，不代表 Win32 命中一定生效；需要 `WM_NCHITTEST -> HTTRANSPARENT` 或兜底 gate。
- 处理：增加 Windows subclass 命中逻辑 + 30Hz cursor gate 兜底（以 mask 为准）。

### B. “panel 召唤后立即消失 / 拖拽缩放也会消失 / 偶现”
- 结论：Windows 的 focus-stealing、MA_NOACTIVATE（avatar 非激活）会让 `blur/focus` 序列非常不稳定。
- 处理：
  - Rust 侧实现全局点外部 watcher 来做“稳定 dismiss”主逻辑。
  - `dismiss_capsule(reason=blur)` 增加前台窗口判定：拖拽/缩放造成的 blur 但仍在前台时不 dismiss。
  - 前端增加 blur grace period（open 后 800ms + focus bounce 250ms）。

### C. “点击 VRM 页的选项导致 hide”
- 结论：原生 `<select>` -> 独立 popup HWND；无法靠 `GA_ROOT/GA_ROOTOWNER` 稳定关联。
- 处理：panel 内全部改成 Radix `Select`。

### D. “chat 面板没有滚轮/滚动”
- 可能原因（需明日继续验证）：
  1) DOM 布局没有形成 overflow（父级 `flex`/`min-h-0` 链路断了）。  
  2) wheel 事件被 avatar window 抢走（panel 未真正获得前台/鼠标在重叠区域）。  
  3) Windows 系统设置“滚轮滚动非活动窗口”关闭，导致必须聚焦 panel 才能滚动。

---

## 关键实现点（明日继续时最常用的入口）

- Panel 自动隐藏（Windows，全局点外部）  
  - `src-tauri/src/windows/panel_window.rs`：`spawn_panel_auto_dismiss`
- Panel dismiss（Rust command + blur 保护）  
  - `src-tauri/src/commands/panel_commands.rs`：`dismiss_capsule`
- 召唤 panel + 置顶/前台（wheel 稳定性相关）  
  - `src-tauri/src/windows/panel_window.rs`：`open_capsule`
- avatar 命中/穿透（subclass + mask）  
  - `src-tauri/src/windows/avatar_window.rs`
- VRM 页/Debug 页下拉（已替换 Radix Select）  
  - `src/windows/panel/tabs/VrmTab.tsx`  
  - `src/windows/panel/tabs/DebugTab.tsx`

---

## Debug 开关/抓日志建议

### 运行命令
- `bun tauri dev`（Windows）

### 建议关注的日志关键词
- `Panel auto-dismiss: hide on outside click`
- `dismiss_capsule: ... reason=blur`
- `Avatar cursor gate ... ignore_cursor_events=...`
- `hitTest: ... mask=...`

### 前端 localStorage（调试阶段）
- `rcat.debug.hittestMouseDot`：小红点开关
- `rcat.debug.hittestOverlay`：命中/边界 overlay（非 DEV 时需要）

---

## 明日 P0 TODO（建议优先级）

1. **验证：panel VRM/Debug 页操作不再触发 hide**（Radix Select 是否完全覆盖）
2. **验证：Chat 滚轮/滚动**（明确是“无滚动条/无 overflow”还是“wheel 不生效”）
   - 如是布局问题：补齐 `min-h-0` / `flex-1` 链路。
   - 如是焦点问题：进一步强化“panel 打开时前台/激活”策略或给出 UX 提示。
3. **完善 outside-click dismiss 的边界**
   - 目前只监听左键；是否需要右键/ESC/任务切换等也触发 hide。
   - 如果后续引入系统文件选择对话框（打开 VRM/动作文件），确认不会误 hide。
4. **收敛日志**
   - debug-only 的详细 HWND 日志可以考虑加开关/按需输出，避免刷屏影响定位。

