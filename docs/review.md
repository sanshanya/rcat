**需要改进/风险点（建议优先修）**

* 文档/注释与真实行为不一致：**.env.example** 仍在暗示用环境变量配置 AI（而现在实际是读 **savedata**），以及 **load_ai_config** 注释仍写 “from .env/environment” 会误导：**.env.example (line 1)**、**config.rs (line 369)**
* Diff 噪音偏大：有不少文件看起来只是换了行尾（CRLF/LF），会让后续 review/merge 很难受；建议用 **.gitattributes** 或一次性跑格式化统一：**index.css (line 1)**
* token 估算 util 里 **joinParts** 的类型守卫写法不太严谨（**typeof type** 会变宽），后续加更多 part 类型时容易埋坑：**contextUsage.ts (line 31)**
* Tailwind 透明度：**bg-muted/45** 这种非常用档位在不同 Tailwind 版本/配置下可能不生效，建议用标准档位（如 **/50**）或显式写法：**ChatMessages.tsx (line 209)**；并考虑把“面板底色/透明度”抽成统一 token，避免到处手调：**PromptInput.tsx (line 112)**

**下一步建议**

* Context 用量目前是估算（可接受），但如果要更准，建议后端在流式结束时拿到 provider 的 **usage** 并发事件给前端，再让 UI 切换成真实值（估算作为 fallback）。


### 2. App.tsx持续增长 (🟡 中等)

 **现状** : 587行,仍然是一个巨大的组件

 **建议拆分** :

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all p-3 my-2 rounded-sm bg-list-hover-subtle"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk21">//</span><span class="mtk21 mtki"> src/hooks/useConversationActions.ts</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk12 mtkb">export</span><span class="mtk3 mtkb"> const </span><span class="mtk4 mtkb">useConversationActions</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk15">()</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">=></span><span class="mtk3 mtkb"></span><span class="mtk15">{</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk7"></span><span class="mtk3 mtkb">const </span><span class="mtk14">handleEditMessage</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">useCallback</span><span class="mtk15">(</span><span class="mtk5">...</span><span class="mtk15">)</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk7"></span><span class="mtk3 mtkb">const </span><span class="mtk14">handleRegenerateFrom</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">useCallback</span><span class="mtk15">(</span><span class="mtk5">...</span><span class="mtk15">)</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk7"></span><span class="mtk3 mtkb">const </span><span class="mtk14">handleDeleteConversation</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">useCallback</span><span class="mtk15">(</span><span class="mtk5">...</span><span class="mtk15">)</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk7"></span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk7"></span><span class="mtk12 mtkb">return</span><span class="mtk7"></span><span class="mtk15">{</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk7"></span><span class="mtk14">handleEditMessage</span><span class="mtk20">,</span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk7"></span><span class="mtk14">handleRegenerateFrom</span><span class="mtk20">,</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk7"></span><span class="mtk14">handleDeleteConversation</span><span class="mtk20">,</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk7"></span><span class="mtk15">}</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk15">}</span><span class="mtk21">;</span></div></div></div></div></div></pre>

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all p-3 my-2 rounded-sm bg-list-hover-subtle"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk21">//</span><span class="mtk21 mtki"> src/hooks/useSettingsDialog.ts</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk12 mtkb">export</span><span class="mtk3 mtkb"> const </span><span class="mtk4 mtkb">useSettingsDialog</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk15">()</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">=></span><span class="mtk3 mtkb"></span><span class="mtk15">{</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk7"></span><span class="mtk3 mtkb">const </span><span class="mtk15">[</span><span class="mtk14">isOpen</span><span class="mtk20">,</span><span class="mtk3 mtkb"></span><span class="mtk14">setIsOpen</span><span class="mtk15">]</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">useState</span><span class="mtk15">(</span><span class="mtk12 mtkb">false</span><span class="mtk15">)</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk7"></span><span class="mtk3 mtkb">const </span><span class="mtk14">open</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">useCallback</span><span class="mtk15">(()</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">=></span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">setIsOpen</span><span class="mtk15">(</span><span class="mtk12 mtkb">true</span><span class="mtk15">)</span><span class="mtk20">,</span><span class="mtk3 mtkb"></span><span class="mtk15">[])</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk7"></span><span class="mtk3 mtkb">const </span><span class="mtk14">close</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">useCallback</span><span class="mtk15">(()</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">=></span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">setIsOpen</span><span class="mtk15">(</span><span class="mtk12 mtkb">false</span><span class="mtk15">)</span><span class="mtk20">,</span><span class="mtk3 mtkb"></span><span class="mtk15">[])</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk7"></span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk7"></span><span class="mtk12 mtkb">return</span><span class="mtk7"></span><span class="mtk15">{</span><span class="mtk7"></span><span class="mtk14">isOpen</span><span class="mtk20">,</span><span class="mtk7"></span><span class="mtk14">open</span><span class="mtk20">,</span><span class="mtk7"></span><span class="mtk14">close</span><span class="mtk7"></span><span class="mtk15">}</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk15">}</span><span class="mtk21">;</span></div></div></div></div></div></pre>

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all p-3 my-2 rounded-sm bg-list-hover-subtle"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk21">//</span><span class="mtk21 mtki"> 在 App.tsx 中使用</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk3 mtkb">function</span><span class="mtk14"></span><span class="mtk4 mtkb">App</span><span class="mtk15">()</span><span class="mtk14"></span><span class="mtk15">{</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk7"></span><span class="mtk3 mtkb">const </span><span class="mtk15">{</span><span class="mtk3 mtkb"></span><span class="mtk14">handleEditMessage</span><span class="mtk20">,</span><span class="mtk3 mtkb"></span><span class="mtk14">handleRegenerateFrom</span><span class="mtk3 mtkb"></span><span class="mtk15">}</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">useConversationActions</span><span class="mtk15">()</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk7"></span><span class="mtk3 mtkb">const </span><span class="mtk15">{</span><span class="mtk3 mtkb"></span><span class="mtk11">isOpen</span><span class="mtk18">:</span><span class="mtk3 mtkb"></span><span class="mtk14">settingsOpen</span><span class="mtk20">,</span><span class="mtk3 mtkb"></span><span class="mtk11">open</span><span class="mtk18">:</span><span class="mtk3 mtkb"></span><span class="mtk14">openSettings</span><span class="mtk20">,</span><span class="mtk3 mtkb"></span><span class="mtk11">close</span><span class="mtk18">:</span><span class="mtk3 mtkb"></span><span class="mtk14">closeSettings</span><span class="mtk3 mtkb"></span><span class="mtk15">}</span><span class="mtk3 mtkb"></span><span class="mtk15">=</span><span class="mtk3 mtkb"></span><span class="mtk4 mtkb">useSettingsDialog</span><span class="mtk15">()</span><span class="mtk21">;</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk7"></span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk7"></span><span class="mtk21">//</span><span class="mtk21 mtki"> ... 简化的逻辑</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk15">}</span></div></div></div></div></div></pre>

---

### 3. SettingsView可以模块化 (💡 低)

 **当前** : 645行单文件

 **建议** :

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all p-3 my-2 rounded-sm bg-list-hover-subtle"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk1">components/</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk1">  settings/</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk1">    SettingsView.tsx         // 主组件</span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk1">    ProviderSelector.tsx     // Provider选择</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk1">    ModelEditor.tsx          // 模型编辑器</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk1">    ApiKeyInput.tsx          // API密钥输入</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk1">    useSettingsForm.ts       // 表单逻辑Hook</span></div></div></div></div></div></pre>

 **好处** :

* 更好的可测试性
* 更清晰的职责
* 更易维护

---

### 4. 文档更新 (💡 低)

 **需要添加** :

<pre><div node="[object Object]" class="relative whitespace-pre-wrap word-break-all p-3 my-2 rounded-sm bg-list-hover-subtle"><div class="w-full h-full text-xs cursor-text"><div class="code-block"><div class="code-line" data-line-number="1" data-line-start="1" data-line-end="1"><div class="line-content"><span class="mtk11"># docs/settings.md</span></div></div><div class="code-line" data-line-number="2" data-line-start="2" data-line-end="2"><div class="line-content"><span class="mtk11">## Settings Management</span></div></div><div class="code-line" data-line-number="3" data-line-start="3" data-line-end="3"><div class="line-content"><span class="mtk14"></span></div></div><div class="code-line" data-line-number="4" data-line-start="4" data-line-end="4"><div class="line-content"><span class="mtk11">### Provider Configuration</span></div></div><div class="code-line" data-line-number="5" data-line-start="5" data-line-end="5"><div class="line-content"><span class="mtk5">-</span><span class="mtk14"> How to add a new provider</span></div></div><div class="code-line" data-line-number="6" data-line-start="6" data-line-end="6"><div class="line-content"><span class="mtk5">-</span><span class="mtk14"> Custom model configuration</span></div></div><div class="code-line" data-line-number="7" data-line-start="7" data-line-end="7"><div class="line-content"><span class="mtk5">-</span><span class="mtk14"> API key security</span></div></div><div class="code-line" data-line-number="8" data-line-start="8" data-line-end="8"><div class="line-content"><span class="mtk14"></span></div></div><div class="code-line" data-line-number="9" data-line-start="9" data-line-end="9"><div class="line-content"><span class="mtk11">### Token Usage Tracking</span></div></div><div class="code-line" data-line-number="10" data-line-start="10" data-line-end="10"><div class="line-content"><span class="mtk5">-</span><span class="mtk14"> How token estimation works</span></div></div><div class="code-line" data-line-number="11" data-line-start="11" data-line-end="11"><div class="line-content"><span class="mtk5">-</span><span class="mtk14"> Understanding the context indicator</span></div></div><div class="code-line" data-line-number="12" data-line-start="12" data-line-end="12"><div class="line-content"><span class="mtk14"></span></div></div><div class="code-line" data-line-number="13" data-line-start="13" data-line-end="13"><div class="line-content"><span class="mtk11">### Troubleshooting</span></div></div><div class="code-line" data-line-number="14" data-line-start="14" data-line-end="14"><div class="line-content"><span class="mtk5">-</span><span class="mtk14"> Connection test failures</span></div></div><div class="code-line" data-line-number="15" data-line-start="15" data-line-end="15"><div class="line-content"><span class="mtk5">-</span><span class="mtk14"> Invalid model configurations</span></div></div></div></div></div></pre>
